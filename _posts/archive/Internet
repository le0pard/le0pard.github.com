---
layout: post
title: Раздача интернета через линукс сервер
wordpress_id: 582
wordpress_url: http://leopard.in.ua/?p=582
---
[![](http://leopard.in.ua/wp-content/uploads/2008/12/c621d4dba1a1892add7d1ce991c7d110_full-235x300.jpg "c621d4dba1a1892add7d1ce991c7d110_full")](http://leopard.in.ua/wp-content/uploads/2008/12/c621d4dba1a1892add7d1ce991c7d110_full.jpg)На работу провели интернет и выдали настройки (ip, mak, gateway, dns-server). Потребовалось раздавать этот интернет на другие машины. Что же, для этого будем использовать машину с линуксом (в моем случае Debian, Ubuntu Server) и двумя сетевыми картами. Вот наша приблизительная схема_**Интернет ------------&gt; |наш пк сервер с линуксом (шлюз)| ------------&gt; другой компьютер (или свич)**_Исходные данные:Оба компьютера соединены по сети.На пк, что будет раздавать инет (далее буду называть его шлюз), установлено 2 сетевые карты:- eth0 - к ней подключен интернет
- eth1 - к ней подключена локальная сеть
<!--more-->Настройте вторую карту (eth1) так (находится в файле /etc/network/interfaces):IP: 192.168.0.1Netmask: 255.255.255.0или введите в консоли:<pre lang="bash">ifconfig eth1 192.168.0.1 netmask 255.255.255.0ifconfig eth1 up</pre>Теперь надо разрешить направление пакетов.Чтобы сделать это, отредактируйте /etc/sysctl.conf: вставьте или раскоментируйте строчку<pre lang="bash">net.ipv4.ip_forward=1</pre>Выполните:<pre lang="bash">sysctl -w net.ipv4.ip_forward="1"</pre>для того, чтобы применить это правило до перезагрузки.Установите iptables (если не установлен), введите следующее правило (для передачи интернета второму компьютеру) и сохраните его.<pre lang="bash">iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</pre>Установите и запустите dnsmasq (или, вы можете использовать DNS провайдера). Мне ДНС выдали, я дописал в /etc/resolv.conf<pre lang="bash">nameserver &lt;айпи днс провайдера&gt;</pre>Установите на втором компьютере (это пример, главное на машинах указывать шлюз и ДНС 192.168.0.1 и подсеть 192.168.0.2-254):IP: 192.168.0.2Netmask/Маска: 255.255.255.0Gateway/Шлюз: 192.168.0.1DNS: 192.168.0.1Второй компьютер теперь должен быть подключён к интернету. :mrgreen:Если после перезагрузки правила iptables не восстанавливаются, добавьте<pre lang="bash">iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</pre>в любой стартовый скрипт (rc.local например).Вот и все. Удачи!**P.S. **В процесе использования возникла неудобная ситуация. При подключении к любым фтп в активном режиме выбивало ошибку_**500 illegal port command**_Оказывается, вспомогательные модули могут быть скомпилированы как в виде подгружаемых модулей ядра, так и статически. Если они скомпилированы как модули, то вы можете загрузить их командойmodprobe ip_conntrack_*Обратите внимание на то, что механизм определения состояния не имеет никакого отношения к трансляции сетевых адресов (NAT), поэтому вам может потребоваться большее количество дополнительных модулей, если вы выполняете такую трансляцию. Допустим, что вы выполняете трансляцию адресов и трассировку FTP соединений, тогда вам необходим так же и соответствующий вспомогательный модуль NAT. Имена вспомогательных модулей NAT начинаются с ip_nat, в соответствии с соглашением об именах. В данном случае модуль называется ip_nat_ftp. Для протокола IRC такой модуль будет называться ip_nat_irc. Тому же самому соглашению следуют и названия вспомогательных модулей трассировщика, например: ip_conntrack_ftp и ip_conntrack_irc.решают проблему такие строки (я, например, их вставил в iptables, можно в тот же rc.local)<pre lang="bash">modprobe ip_conntrack_ftpmodprobe ip_nat_ftp</pre>Все 8-)
