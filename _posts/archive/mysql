---
layout: post
title: Тюнинг nginx, mysql, php на VPS.
wordpress_id: 528
wordpress_url: http://leopard.in.ua/?p=528
---
Достался мне как то VPS сервер на котором крутился региональный торрент трекер. Все ужасно тормозило и часто трекер был недоступен. Так как я люблю торрент трекеры - то предложил ребятам заняться тюнингом, они не отказались.Все это крутилось на виртуальном выделенном сервере (VPS). Параметры VPS были такие 500 мГц CPU и 386M памяти, система Debian Etch 4. Веб сервер стоял на apache1.3, в качестве базы данных использовалась mysql5.0. Мною была произведена предварительная настройка:_**Шаг 1. Установка nginx**_Пришлось похоронить apache и заменить его на nginx. Причины как обычно, ускоренная отдача статики и меньшее потребление памяти. Статей на эту тему в интернете полным-полно.Нужные пакеты: nginx<!--more-->_**Шаг 2. Перевод php в режим fastcgi**_Для этого используем следующий [ скрипт](http://lastage.ru/files/run_php_cgi).Нужные пакеты: php-cgi, lighttpd. Подробно тоже останавливатся не буду._**Шаг 3. Установка mysql последней версии**_Ставим mysql5.1 одной из последних версий. Для debian он берется из backports.Нужные пакеты: mysql5_**Шаг 4.**_Настраиваем все и заставляем работать. Я специально не стал останавливаться на настройке nginx и mysql - они многократно были описаны в интернете.**Запуск**На наш ресурс стали захаживать посетители и nginx встречал их любимой ошибкой “502 Bad Gateway”. Причиной отказа стал nginx, он не мог открыть tcp сокет - о чем радостно вопил в логе._**Проблема 1. Ограниченное количество tcp сокетов**_Набрав команду:_ cat /proc/user_beancounters_ мы видим``uid  resource           held    maxheld    barrier      limit    failcnt342:  kmemsize        6560447    7965730    8192000    9011200          0lockedpages           0          0         64         64          0privvmpages       32802      72065      65536      72090        140shmpages          10371      10387      16384      16384          0** numtcpsock           120         62        250        250          56734**[..cut..]``что напротив параметра numtcpsock постоянно увеличивающуюся циферку в последнем ряду - это отказы в доступных tcp сокетах. Нам не хватает сокетов для работы - увеличить их количество нельзя, это обычно ограничения хостера на создаваемые VPS.Решение: на 1 соединение nginx приходится 1 tcp сокет? Как бы нитак, ответ 3. Один себе забирает nginx, 1 mysql, 1 php.** НО!** Php и mysql работаю локально - значит их можно переводить на unix сокеты.Для этого для php в  [ скрипте](http://lastage.ru/files/run_php_cgi) изменяем:``FCGIPORT="8888"``на``FCGIPORT="/var/run/spawn/fastcgi_socket"``далее``if test x$UID = x0; thenEX="$SPAWNFCGI -p $FCGIPORT -f $FCGIPROGRAM -u $USERID -g $GROUPID -C $PHP_FCGI_CHILDREN"elseEX="$SPAWNFCGI -p $FCGIPORT -f $FCGIPROGRAM -C $PHP_FCGI_CHILDREN"fi``на``if test x$UID = x0; thenEX="$SPAWNFCGI -s $FCGIPORT -f $FCGIPROGRAM -u $USERID -g $GROUPID -C $PHP_FCGI_CHILDREN"elseEX="$SPAWNFCGI -s $FCGIPORT -f $FCGIPROGRAM -C $PHP_FCGI_CHILDREN"fi``.Для mysql соединяемся из mysql_connect не с “localhost”, a “:/var/run/mysqld/mysqld.sock”.Количество сокетов уменьшилось в системе - но его можно еще уменьшить - уличная магия да и только. Набрав команду netstat -a - мы видим кучу соединений и некоторые чего-то ждут. Для того что бы ждали поменьше - выставляем в конфиге nginx параметр:``keepalive_timeout  0;``Он означает, что отдав вебсервер отдав контент - закроет соединение, а не будет висеть и ждать 60 секунд - занимая сокет.Ура ресурсу полегчало, но не радовала маленькая скорость загрузки страниц. На этот раз стало понятно, что mysql выжирает кучу процессора и параметр iowait высок._**Проблема 2: Маленькая скорость mysql.**_Я не большой спец тюнингу по mysql, решил воспользоваться рекомендациями гуру написавшими данный [скрипт](http://lastage.ru/files/tuning-primer.sh). Скрипт смотрит статистику по работающему mysql ( желательно, что бы он проработал более 48 часов) подсказывает, что у вас не так. Мне пришлось править следующие параметры в my.cnfmax_connections = 15; // количество одновременных соединений - на VPS не много памяти, а mysql выделяет на каждое соеденение кучу памятиkey_buffer              = 30M; // mysql по подсказкам [скрипта](http://lastage.ru/files/tuning-primer.sh) использует всего 22Mtable_cache            = 256; //количество одновременно открытых таблиц+ кучку обычных настроекskip-innodb; // трекер использует только myisam таблицыотключить все логи - что бы диск не был занят_**Проблема 3. Уменьшение занимаемой памяти.**_Установка [eAccelerator](http://lastage.ru/jexr/aHR0cDovL2VhY2NlbGVyYXRvci5uZXQv "http://eaccelerator.net/") для php. Данный модуль компит php в байт код ускоряя его работу и уменьшая занимаемую память. Самое главное тут, что бы все скомпиленые php файлы умещались в shared memory. Для диагностики выполните файлик test.php:`` ``Ищем следующие строки:Memory Size 33,554,396 BytesMemory Available 19,280,056 BytesMemory Allocated 14,274,340 BytesЕсли Memory Available будет близко к нулю - для этого мы должны ее увеличить, иначе все будет кешироватся на диск. Для этого под рутом выполняем``echo 134217728 &gt;/proc/sys/kernel/shmall #выделяем 128Mecho 134217728 &gt;/proc/sys/kernel/shmmax``и перезагружаем машину .В результате этой не большой настройки трекер обслуживая порядка 50 пользователей одновременно онлайн - по top занимает всего 200 M памяти и средней нагрузке 2.0.PS: дальнейшая оптимизация упирается только в CPU и требует более мощной тачки. Некоторые команды могу у вас не пойти, я так и не понял как создать swap на VPS ( при создании пишет, что в доступе отказано).[Источник](http://lastage.ru/tunning_nginx_mysql_php_vps.html)
