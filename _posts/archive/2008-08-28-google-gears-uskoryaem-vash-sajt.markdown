---
layout: post
title: Google Gears - ускоряем ваш сайт
wordpress_id: 106
wordpress_url: http://leopard.in.ua/?p=106
categories:
- Ajax
- Google
tags:
- web 2.0
- Google
- Gears
---
**Google Gears** — [открытое программное обеспечение](http://ru.wikipedia.org/wiki/%D0%9E%D1%82%D0%BA%D1%80%D1%8B%D1%82%D0%BE%D0%B5_%D0%BF%D1%80%D0%BE%D0%B3%D1%80%D0%B0%D0%BC%D0%BC%D0%BD%D0%BE%D0%B5_%D0%BE%D0%B1%D0%B5%D1%81%D0%BF%D0%B5%D1%87%D0%B5%D0%BD%D0%B8%D0%B5 "Открытое программное обеспечение") от [Google](http://ru.wikipedia.org/wiki/Google "Google") (бета, лицензия [BSD](http://ru.wikipedia.org/wiki/BSD "BSD")), позволяющее использование [веб-приложений](http://ru.wikipedia.org/wiki/%D0%92%D0%B5%D0%B1-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5 "Веб-приложение") с помощью [браузеров](http://ru.wikipedia.org/wiki/%D0%91%D1%80%D0%B0%D1%83%D0%B7%D0%B5%D1%80 "Браузер") [Mozilla Firefox](http://ru.wikipedia.org/wiki/Mozilla_Firefox "Mozilla Firefox") и [Internet Explorer](http://ru.wikipedia.org/wiki/Internet_Explorer "Internet Explorer") под [GNU/Linux](http://ru.wikipedia.org/wiki/GNU/Linux "GNU/Linux"), [Mac OS](http://ru.wikipedia.org/wiki/Mac_OS "Mac OS") и [Microsoft Windows](http://ru.wikipedia.org/wiki/Microsoft_Windows "Microsoft Windows") в режиме [оффлайн](http://ru.wikipedia.org/wiki/%D0%9E%D1%84%D1%84%D0%BB%D0%B0%D0%B9%D0%BD "Оффлайн").Специальный плагин заставляет браузер работать с локальным [кешем](http://ru.wikipedia.org/wiki/%D0%9A%D0%B5%D1%88 "Кеш") страниц (на основе [SQLite](http://ru.wikipedia.org/wiki/SQLite "SQLite")), периодически синхронизируя кеш с [онлайн](http://ru.wikipedia.org/wiki/%D0%9E%D0%BD%D0%BB%D0%B0%D0%B9%D0%BD "Онлайн") источником.**Google gears** представляет собой [AJAX](http://ru.wikipedia.org/wiki/AJAX "AJAX")-API и работает только с веб-сайтами, специально поддерживающими этот сервис. ([Источник](http://ru.wikipedia.org/wiki/Google_Gears))Так вот, почитав немного документацию, я решил интегрировать такую вещь в онлайн игрушку, которую я сейчас программирую. Итак начнем.<!--more-->Итак, сначала нам потребуется [gears_init.js.](http://code.google.com/apis/gears/gears_init.js) Что б не инклудить его отдельно на страницу, я просто допишу содержимое в скрипт<pre lang="javascript">myGears = {createStore : function() {if ( 'undefined' == typeof google || ! google.gears ) return;if ( 'undefined' == typeof localServer )localServer = google.gears.factory.create("beta.localserver");store = localServer.createManagedStore(this.storeName());store.manifestUrl = "gears-manifest.php";store.checkForUpdate();this.window();},getPermission : function() {if ( 'undefined' != typeof google  && google.gears ) {if ( ! google.gears.factory.hasPermission )google.gears.factory.getPermission( 'MySite', 'images/logo.png' );try {this.createStore();} catch(e) {} // отмена, отказ от пользователя}},storeName : function() {var name = window.location.protocol + window.location.host;name = name.replace(/[\/\\:*?&lt;&gt;|;,]+/g, '_'); // gears beta не поддерживает эти символыname = name.substring(0, 64); // максимальная длинна - 64 символаreturn name;},window : function(show) {var t = this,msg1 = t.I('gears-msg1'),msg2 = t.I('gears-msg2'),msg3 = t.I('gears-msg3'),num = t.I('gears-upd-number'),wait = t.I('gears-wait');if ( ! msg1 ) return;if ( 'undefined' != typeof google  && google.gears ) {if ( google.gears.factory.hasPermission ) {msg1.style.display = msg2.style.display = 'none';msg3.style.display = 'block';if ( 'undefined' == typeof store )t.createStore();store.oncomplete = function(){wait.innerHTML = (' Синхронизация завершена' );};store.onerror = function(){wait.innerHTML = ('Ошибка :  ' +  store.lastErrorMessage);};store.onprogress = function(e){if(num) num.innerHTML = (' ' + e.filesComplete + ' / ' + e.filesTotal);};} else {msg1.style.display = msg3.style.display = 'none';msg2.style.display = 'block';}}if ( show ) t.I('gears-info-box').style.display = 'block';},I : function(id) {return document.getElementById(id);}};//кусок кода с gears_init.js//Инициализация gears(function() {if ( 'undefined' != typeof google && google.gears ) return;var gf = false;if ( 'undefined' != typeof GearsFactory ) {gf = new GearsFactory();} else {try {gf = new ActiveXObject('Gears.Factory');if ( factory.getBuildInfo().indexOf('ie_mobile') != -1 )gf.privateSetGlobalObject(this);} catch (e) {if ( ( 'undefined' != typeof navigator.mimeTypes ) &amp;&amp; navigator.mimeTypes['application/x-googlegears'] ) {gf = document.createElement("object");gf.style.display = "none";gf.width = 0;gf.height = 0;gf.type = "application/x-googlegears";document.documentElement.appendChild(gf);}}}if ( ! gf ) return;if ( 'undefined' == typeof google ) google = {};if ( ! google.gears ) google.gears = { factory : gf };})();</pre>Итак, поясню по порядку.**createStore** - понятно по названию, данный метод создает хранилище для наших файлов.<pre lang="javascript">if ( 'undefined' == typeof google && ! google.gears ) return;</pre>Проверяем что Gears у нас установлен.<pre lang="javascript">if ( 'undefined' == typeof localServer )localServer = google.gears.factory.create("beta.localserver");store = localServer.createManagedStore(this.storeName());</pre>Инициализируем локальное хранилище и даем ему имя (имя создает метод **storeName**)<pre lang="javascript">store.checkForUpdate();</pre>Синхронизируем кеш с онлайн источником.<pre lang="javascript">this.window();</pre>Показываем окно (окно с сообщениями).**getPermission** - с помощью этого метода будем запрашивать разрешения использовать Gears для нашего сайта<pre lang="javascript">if ( ! google.gears.factory.hasPermission )google.gears.factory.getPermission( 'MySite', 'images/logo.png' );</pre>Если у нас нет прав для хранения файлов для этого сайта - запрашиваем. Передается два параметра - Имя сайта и логотип. Вот как оно приблизительно выглядит[caption id="attachment_116" align="alignnone" width="300" caption="Gears"][![Gears](http://leopard.in.ua/wp-content/uploads/2008/08/123-300x212.png "Gears")](http://leopard.in.ua/wp-content/uploads/2008/08/123.png)[/caption]И если пользователь согласится - создаем хранилище выше перечисленным методом **createStore.****storeName** - как уже и говорилось выше генерируем имя для хранилища.**window** - работа с окошками. Их у нас будет 3 типа:- gears ещё не установлен;- gears установлен, но сайт ещё не добавлен для работы в нем;- gears установлен и добавлен для работы, просто синхронизируем с сервером.Для этого у нас будет 3 дива (2 скрыты по умолчанию, третий - нет). Они буду находится в главном, который будет появляться при вызове **window.**Вот сам HTML :<pre lang="html">&lt;div id="gears-info-box" class="info-box" style="display:none;"&gt;&lt;div id="gears-msg1"&gt;&lt;button class="button" onclick="window.location = 'http://gears.google.com/?action=install&amp;amp;return=http%3A%2F%2Fyousite%2F';"&gt;Установить сейчас&lt;/button&gt;&lt;button class="button" style="margin-left:10px;" onclick="document.getElementById('gears-info-box').style.display='none';"&gt;Отмена&lt;/button&gt;&lt;/div&gt;&lt;div id="gears-msg2" style="display:none;"&gt;&lt;div class="submit"&gt;&lt;button class="button" onclick="myGears.getPermission();"&gt;Включить Gears&lt;/button&gt;&lt;button class="button" style="margin-left:10px;" onclick="document.getElementById('gears-info-box').style.display='none';"&gt;Отмена&lt;/button&gt;&lt;/div&gt;&lt;div id="gears-msg3" style="display:none;"&gt;Статус локального хранилища: &lt;span id="gears-wait"&gt;&lt;span style="color: #ff0000;"&gt;Пожалуйста подождите! Идет загрузка файлов:&lt;/span&gt; &lt;/span&gt;&lt;button class="button" onclick="document.getElementById('gears-info-box').style.display='none';"&gt;Закрыть&lt;/button&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;</pre>Теперь займенся хранилищем на сервере. Это проще простого. Если вы заметили у нас в коде создания хранилища был такой кусок кода<pre lang="javascript">store.manifestUrl = "gears-manifest.php";</pre>Как раз это указывает где на сервере в файле gears-manifest.php. В нем мы должны перечислить файлы, что будем кешировать (картинки, скрипты, статические файлы). Должен он выглядеть приблизительно так<pre>``{"betaManifestVersion": 1,"version": "версия хранилища","entries": [{ "url" : "images/morgue/bg01.jpg" },{ "url" : "images/bar/button.jpg" }]}``</pre>Я весь код не выложу, он огромный, но главное в нем - рекурсивно пройтись по каталогам, выбрать картинки и каскадные таблицы стилей.<pre lang="php">$defaults = $man_version = '';foreach ( $list_files as $script ) {$defaults .= '{ "url" : "' . $src . '?ver=' . $ver . '" },' . "\n";$man_version .= $ver;}$man_version = md5($man_version);header( 'Expires: Wed, 11 Jan 1984 05:00:00 GMT' );header( 'Last-Modified: ' . gmdate( 'D, d M Y H:i:s' ) . ' GMT' );header( 'Cache-Control: no-cache, must-revalidate, max-age=0' );header( 'Pragma: no-cache' );header( 'Content-Type: application/x-javascript; charset=UTF-8' );?&gt;{"betaManifestVersion" : 1,"version" : "&lt;?php echo $man_version; ?&gt;_20080828","entries" : [&lt;?php echo $defaults; ?&gt;]}</pre>Если у меня в каталогах появятся новые картинки, или изменится версия css файла - gears загрузит измененное. Если сменит version - он перезагрузит все хранилище.Вот и все._Удачи вам в программирование!_
