---
layout: post
title: imagefilter функция с внешней библиотекой GD
wordpress_id: 663
wordpress_url: http://leopard.in.ua/?p=663
categories:
- PHP
tags:
- PHP
---
[![gdlogobig](http://leopard.in.ua/wp-content/uploads/2009/01/gdlogobig-300x194.png "gdlogobig")](http://leopard.in.ua/wp-content/uploads/2009/01/gdlogobig.png)Один очень ["хороший человек"](http://terion-fallen.livejournal.com/) пообещал заказчику золотые горы и слинял. Понятное дело делать пришлось это мне. Пришлось регестрировать так же хостинг и возиться с ним (хостинг порекомендовал тот же человек). И что получилось? После заливки сайта там не оказалось функции PHP [imagefilter()](http://ua2.php.net/imagefilter), которую надо было юзать для галереии (серые картинки + немного осветленные). Скрипт выдавал``Fatal error: Call to undefined function imagefilter()``Написал в супорт. Мне ответили, что_Функция imagefilter() есть в пхп который собран с встроенной библиотекой GD, у нас php используется с внешней библиотекой GD, такой функции она не поддерживает._Дамс... Пришлось писать свой выход из этой ситуации (не без помощи Google).<!--more--><pre lang="php">&lt;?phpif(!function_exists('imagefilter')){define('IMAGE_FILTER_NEGATE',0);define('IMAGE_FILTER_GRAYSCALE',1);define('IMAGE_FILTER_BRIGHTNESS',2);define('IMAGE_FILTER_CONTRAST',3);define('IMAGE_FILTER_COLORIZE',4);define('IMAGE_FILTER_EDGEDETECT',5);define('IMAGE_FILTER_EMBOSS',6);define('IMAGE_FILTER_GAUSSIAN_BLUR',7);define('IMAGE_FILTER_SELECTIVE_BLUR',8);define('IMAGE_FILTER_MEAN_REMOVAL',9);define('IMAGE_FILTER_SMOOTH',10);function imagefilter($source, $var, $arg1 = null, $arg2 = null, $arg3 = null){$max_y = imagesy($source);$max_x = imagesx($source);switch ($var){case 0:$y = 0;while($y&lt;$max_y) {$x = 0;while($x&lt;$max_x){$rgb = imagecolorat($source,$x,$y);$r = 255 - (($rgb &gt;&gt; 16) &amp; 0xFF);$g = 255 - (($rgb &gt;&gt; 8) &amp; 0xFF);$b = 255 - ($rgb &amp; 0xFF);$a = $rgb &gt;&gt; 24;$new_pxl = imagecolorallocatealpha($source, $r, $g, $b, $a);if ($new_pxl == false){$new_pxl = imagecolorclosestalpha($source, $r, $g, $b, $a);}imagesetpixel($source,$x,$y,$new_pxl);++$x;}++$y;}return true;break;case 1:$y = 0;while($y&lt;$max_y) {$x = 0;while($x&lt;$max_x){$rgb = imagecolorat($source,$x,$y);$a = $rgb &gt;&gt; 24;$r = ((($rgb &gt;&gt; 16) &amp; 0xFF)*0.299)+((($rgb &gt;&gt; 8) &amp; 0xFF)*0.587)+(($rgb &amp; 0xFF)*0.114);$new_pxl = imagecolorallocatealpha($source, $r, $r, $r, $a);if ($new_pxl == false){$new_pxl = imagecolorclosestalpha($source, $r, $r, $r, $a);}imagesetpixel($source,$x,$y,$new_pxl);++$x;}++$y;}return true;break;case 2:$y = 0;while($y&lt;$max_y) {$x = 0;while($x&lt;$max_x){$rgb = imagecolorat($source,$x,$y);$r = (($rgb &gt;&gt; 16) &amp; 0xFF) + $arg1;$g = (($rgb &gt;&gt; 8) &amp; 0xFF) + $arg1;$b = ($rgb &amp; 0xFF) + $arg1;$a = $rgb &gt;&gt; 24;$r = ($r &gt; 255)? 255 : (($r &lt; 0)? 0:$r);$g = ($g &gt; 255)? 255 : (($g &lt; 0)? 0:$g);$b = ($b &gt; 255)? 255 : (($b &lt; 0)? 0:$b);$new_pxl = imagecolorallocatealpha($source, $r, $g, $b, $a);if ($new_pxl == false){$new_pxl = imagecolorclosestalpha($source, $r, $g, $b, $a);}imagesetpixel($source,$x,$y,$new_pxl);++$x;}++$y;}return true;break;case 3:$contrast = pow((100-$arg1)/100,2);$y = 0;while($y&lt;$max_y) {$x = 0;while($x&lt;$max_x){$rgb = imagecolorat($source,$x,$y);$a = $rgb &gt;&gt; 24;$r = (((((($rgb &gt;&gt; 16) &amp; 0xFF)/255)-0.5)*$contrast)+0.5)*255;$g = (((((($rgb &gt;&gt; 8) &amp; 0xFF)/255)-0.5)*$contrast)+0.5)*255;$b = ((((($rgb &amp; 0xFF)/255)-0.5)*$contrast)+0.5)*255;$r = ($r &gt; 255)? 255 : (($r &lt; 0)? 0:$r);$g = ($g &gt; 255)? 255 : (($g &lt; 0)? 0:$g);$b = ($b &gt; 255)? 255 : (($b &lt; 0)? 0:$b);$new_pxl = imagecolorallocatealpha($source, $r, $g, $b, $a);if ($new_pxl == false){$new_pxl = imagecolorclosestalpha($source, $r, $g, $b, $a);}imagesetpixel($source,$x,$y,$new_pxl);++$x;}++$y;}return true;break;case 4:$x = 0;while($x&lt;$max_x){$y = 0;while($y&lt;$max_y){$rgb = imagecolorat($source, $x, $y);$r = (($rgb &gt;&gt; 16) &amp; 0xFF) + $arg1;$g = (($rgb &gt;&gt; 8) &amp; 0xFF) + $arg2;$b = ($rgb &amp; 0xFF) + $arg3;$a = $rgb &gt;&gt; 24;$r = ($r &gt; 255)? 255 : (($r &lt; 0)? 0:$r);$g = ($g &gt; 255)? 255 : (($g &lt; 0)? 0:$g);$b = ($b &gt; 255)? 255 : (($b &lt; 0)? 0:$b);$new_pxl = imagecolorallocatealpha($source, $r, $g, $b, $a);if ($new_pxl == false){$new_pxl = imagecolorclosestalpha($source, $r, $g, $b, $a);}imagesetpixel($source,$x,$y,$new_pxl);++$y;}++$x;}return true;break;case 5:return imageconvolution($source, array(array(-1,0,-1), array(0,4,0), array(-1,0,-1)), 1, 127);break;case 6:return imageconvolution($source, array(array(1.5, 0, 0), array(0, 0, 0), array(0, 0, -1.5)), 1, 127);break;case 7:return imageconvolution($source, array(array(1, 2, 1), array(2, 4, 2), array(1, 2, 1)), 16, 0);break;case 8:for($y = 0; $y&lt;$max_y; $y++) {for ($x = 0; $x&lt;$max_x; $x++) {$flt_r_sum = $flt_g_sum = $flt_b_sum = 0;$cpxl = imagecolorat($source, $x, $y);for ($j=0; $j&lt;3; $j++) {for ($i=0; $i&lt;3; $i++) {if (($j == 1) &amp;&amp; ($i == 1)) {$flt_r[1][1] = $flt_g[1][1] = $flt_b[1][1] = 0.5;} else {$pxl = imagecolorat($source, $x-(3&gt;&gt;1)+$i, $y-(3&gt;&gt;1)+$j);$new_a = $pxl &gt;&gt; 24;//$r = (($pxl &gt;&gt; 16) &amp; 0xFF);//$g = (($pxl &gt;&gt; 8) &amp; 0xFF);//$b = ($pxl &amp; 0xFF);$new_r = abs((($cpxl &gt;&gt; 16) &amp; 0xFF) - (($pxl &gt;&gt; 16) &amp; 0xFF));if ($new_r != 0) {$flt_r[$j][$i] = 1/$new_r;} else {$flt_r[$j][$i] = 1;}$new_g = abs((($cpxl &gt;&gt; 8) &amp; 0xFF) - (($pxl &gt;&gt; 8) &amp; 0xFF));if ($new_g != 0) {$flt_g[$j][$i] = 1/$new_g;} else {$flt_g[$j][$i] = 1;}$new_b = abs(($cpxl &amp; 0xFF) - ($pxl &amp; 0xFF));if ($new_b != 0) {$flt_b[$j][$i] = 1/$new_b;} else {$flt_b[$j][$i] = 1;}}$flt_r_sum += $flt_r[$j][$i];$flt_g_sum += $flt_g[$j][$i];$flt_b_sum += $flt_b[$j][$i];}}for ($j=0; $j&lt;3; $j++) {for ($i=0; $i&lt;3; $i++) {if ($flt_r_sum != 0) {$flt_r[$j][$i] /= $flt_r_sum;}if ($flt_g_sum != 0) {$flt_g[$j][$i] /= $flt_g_sum;}if ($flt_b_sum != 0) {$flt_b[$j][$i] /= $flt_b_sum;}}}$new_r = $new_g = $new_b = 0;for ($j=0; $j&lt;3; $j++) {for ($i=0; $i&lt;3; $i++) {$pxl = imagecolorat($source, $x-(3&gt;&gt;1)+$i, $y-(3&gt;&gt;1)+$j);$new_r += (($pxl &gt;&gt; 16) &amp; 0xFF) * $flt_r[$j][$i];$new_g += (($pxl &gt;&gt; 8) &amp; 0xFF) * $flt_g[$j][$i];$new_b += ($pxl &amp; 0xFF) * $flt_b[$j][$i];}}$new_r = ($new_r &gt; 255)? 255 : (($new_r &lt; 0)? 0:$new_r);$new_g = ($new_g &gt; 255)? 255 : (($new_g &lt; 0)? 0:$new_g);$new_b = ($new_b &gt; 255)? 255 : (($new_b &lt; 0)? 0:$new_b);$new_pxl = ImageColorAllocateAlpha($source, (int)$new_r, (int)$new_g, (int)$new_b, $new_a);if ($new_pxl == false) {$new_pxl = ImageColorClosestAlpha($source, (int)$new_r, (int)$new_g, (int)$new_b, $new_a);}imagesetpixel($source,$x,$y,$new_pxl);}}return true;break;case 9:return imageconvolution($source, array(array(-1,-1,-1),array(-1,9,-1),array(-1,-1,-1)), 1, 0);break;case 10:return imageconvolution($source, array(array(1,1,1),array(1,$arg1,1),array(1,1,1)), $arg1+8, 0);break;}}}?&gt;</pre>Что бы не мучатся с копипастом скрипта - вот вам [код в текстовом формате](http://leopard.in.ua/data/imagefilter.php.txt). Подключаете его и все, если функция есть на сервере - он не будет ей мешать, если нет -  будет работать за нее.Все! Удачи.
