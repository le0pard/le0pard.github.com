---
layout: post
title: Настройка Ubuntu и источника бесперебойного питания APC ES 525 Back-UPS
wordpress_id: 565
wordpress_url: http://leopard.in.ua/?p=565
---
![](http://leopard.in.ua/wp-content/uploads/2008/12/apc-smart-ups-xl-750va-usb.gif "apc-smart-ups-xl-750va-usb")Моя общага меня всегда радует. На щитке с электричеством были проблемы - он выбивал выключатель при перегрузке электросети. Попросили починить. Теперь он и не врубается. :mrgreen: Ну все как всегда. Слава богу на сервере есть UPS, но он часто не выдерживал и при кончине - просто вырубал машину по "жестокому". Подумал - надо что то с этим делать.Итак, имеем сервер с Ubuntu Linux на борту и подключенный к нему бесперебойник APC Back-UPS ES 525. Задача - при разряде аккумуляторов бесперебойника, сервер должен "аккуратно" выключиться.<!--more-->Первое - подключите UPS к одному из USB портов сервера.Дальше - ставим наш демон**sudo apt-get install apcupsd**Дальше для Ubuntu (Debian) пишем в консоли**cat /proc/bus/usb/devices **Если скажет, что файла нет, тогда выполните следующую команду и повторите **mount -t usbfs usbfs /proc/bus/usb/**Должно вывести информацию по usb портам (пример)**# cat /proc/bus/usb/devices****T:  Bus=02 Lev=00 Prnt=00 Port=00 Cnt=00 Dev#=  1 Spd=480 MxCh=10B:  Alloc=  0/800 us ( 0%), #Int=  0, #Iso=  0D:  Ver= 2.00 Cls=09(hub  ) Sub=00 Prot=01 MxPS=64 #Cfgs=  1P:  Vendor=0000 ProdID=0000 Rev= 2.06S:  Manufacturer=Linux 2.6.24-16-server ehci_hcdS:  Product=EHCI Host ControllerS:  SerialNumber=0000:00:02.1C:* #Ifs= 1 Cfg#= 1 Atr=e0 MxPwr=  0mAI:* If#= 0 Alt= 0 #EPs= 1 Cls=09(hub  ) Sub=00 Prot=00 Driver=hubE:  Ad=81(I) Atr=03(Int.) MxPS=   4 Ivl=256ms****T:  Bus=01 Lev=00 Prnt=00 Port=00 Cnt=00 Dev#=  1 Spd=12  MxCh=10B:  Alloc=  0/900 us ( 0%), #Int=  0, #Iso=  0D:  Ver= 1.10 Cls=09(hub  ) Sub=00 Prot=00 MxPS=64 #Cfgs=  1P:  Vendor=0000 ProdID=0000 Rev= 2.06S:  Manufacturer=Linux 2.6.24-16-server ohci_hcdS:  Product=OHCI Host ControllerS:  SerialNumber=0000:00:02.0C:* #Ifs= 1 Cfg#= 1 Atr=e0 MxPwr=  0mAI:* If#= 0 Alt= 0 #EPs= 1 Cls=09(hub  ) Sub=00 Prot=00 Driver=hubE:  Ad=81(I) Atr=03(Int.) MxPS=   2 Ivl=255ms****T:  Bus=01 Lev=01 Prnt=01 Port=02 Cnt=01 Dev#=  2 Spd=1.5 MxCh= 0D:  Ver= 1.10 Cls=00(&gt;ifc ) Sub=00 Prot=00 MxPS= 8 #Cfgs=  1P:  Vendor=051d ProdID=0002 Rev= 0.06<span style="color: #ff0000;">S:  Manufacturer=American Power ConversionS:  Product=Back-UPS ES 525 FW:851.t2.I USB FW:t2 </span>S:  SerialNumber=BB0629038331C:* #Ifs= 1 Cfg#= 1 Atr=e0 MxPwr=  2mAI:* If#= 0 Alt= 0 #EPs= 1 Cls=03(HID  ) Sub=00 Prot=00 Driver=usbhidE:  Ad=81(I) Atr=03(Int.) MxPS=   6 Ivl=100ms **Вот и наш UPS (пометил красным)! Можем продолжать. Если информации по нем не вывело - проблемы с подключением UPS к серверу.Ну у нас все в норме.Далее создаём файл  **/etc/udev/rules.d/50-udev.rules **и прописываем в него:BUS="usb", SYSFS{idVendor}="**051d**", NAME="usb/hiddev%n"** 051d **берётся из вывода команды   **cat /proc/bus/usb/devices **(см выше) из строки **Vendor **Следующим шагом будет редактирование **/etc/apcupsd/apcupsd.conf **. Проверяем (исправляем) параметры на следующие значения:** UPSCABLE usb **** UPSTYPE usb **** DEVICE **** LOCKFILE /var/lock **** UPSCLASS standalone **** UPSMODE disable **далее редактируем файл:  /etc/default/apcupsd. В строке **ISCONFIGURED** вместо **NO** пишем **YES**Рестартуем демон: **sudo** **/etc/init.d/apcupsd restart**Если всё сделали правильно, то запуск команды  **apcaccess **выдаст следующее:APC      : 001,037,0912DATE     : Tue Dec 02 23:12:55 EET 2008HOSTNAME : leo.localRELEASE  : 3.14.2VERSION  : 3.14.2 (15 September 2007) debianUPSNAME  : leo.localCABLE    : USB CableMODEL    : Back-UPS ES 525UPSMODE  : Stand AloneSTARTTIME: Tue Dec 02 22:39:50 EET 2008STATUS   : ONLINELINEV    : 233.2 VoltsLOADPCT  :  31.0 Percent Load CapacityBCHARGE  : 040.0 PercentTIMELEFT :   3.6 MinutesMBATTCHG : 5 PercentMINTIMEL : 3 MinutesMAXTIME  : 0 SecondsSENSE    : MediumLOTRANS  : 195.0 VoltsHITRANS  : 255.0 VoltsALARMDEL : AlwaysBATTV    : 13.4 VoltsLASTXFER : Unacceptable line voltage changesNUMXFERS : 0TONBATT  : 0 secondsCUMONBATT: 0 secondsXOFFBATT : N/ASELFTEST : NOSTATFLAG : 0x07000008 Status FlagSERIALNO : BB0629038331BATTDATE : 2006-07-13NOMOUTV  : 2300NOMINV   : 230NOMBATTV :  12.0FIRMWARE : 851.t2.I USB FW:t2APCMODEL : Back-UPS ES 525END APC  : Tue Dec 02 23:12:55 EET 2008Так же можно проверить работоспособность системы с помощью команды **apctest**, предварительно остановив демон **apcupsd**Проверка в боевых условиях проста: в терминале запускаем мониторинг лог-файла демона **apcupsd**: ******tail -f /var/log/apcupsd.events**и  отключаем шнур питания бесперебойника.  :mrgreen:Но на этом не остановимся. Давайте ещё web интерфейс мониторинга сделаем (дальше я расматриваю пример когда на сервере уже стоит настроеный http сервер с поддержкой cgi).Ставим**apt-get install apcupsd-cgi**Странно, но скриптов нет, только конфиги. Лады, не проблема, качаем исходники (я скачал [тут](https://launchpad.net/ubuntu/hardy/+package/apcupsd-cgi)). распаковываем, заходи в распакованую директорию и пишем**./configure --enable-cgi ; make**Теперь заходи в директории и ищем multimon.cgi, upsstats.cgi, upsfstatus.cgi (ещё там можно забрать apcupsd.css). Сбрасываем эти файлы в директорию веб-сервера. Заходим и тестим. Не забудте выставить права на файлы, а также возможно сменить в /etc/apcupsd/hosts.conf**MONITOR 127.0.0.1 "Local Host"**на**MONITOR 127.0.0.1:3551 "Local Host"**поскольку демон по умолчанию висит на 3551 порту (можно поменять порт при запуске демона при ./configure аргументом --with-nis-port=7001, где 7001 - порт).Вот скриншоты веб-интерфейса[![](http://leopard.in.ua/wp-content/uploads/2008/12/multimon.png "multimon")](http://leopard.in.ua/wp-content/uploads/2008/12/multimon.png)[![](http://leopard.in.ua/wp-content/uploads/2008/12/status.png "status")](http://leopard.in.ua/wp-content/uploads/2008/12/status.png)Вот и все. Удачи!
